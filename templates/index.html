<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Late Show - Restaurant Pizza Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .list {
            margin-bottom: 15px;
        }
        .list-item {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .list-item button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .list-item button:hover {
            background: #c82333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 5px;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        button:hover {
            background: #764ba2;
        }
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: none;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .loading {
            text-align: center;
            color: #999;
            font-style: italic;
        }
        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Restaurant Pizza Manager</h1>
        
        <div class="sections">
            <!-- Restaurants Section -->
            <div class="card">
                <h2>Restaurants</h2>
                <div class="message" id="restaurantMessage"></div>
                <div class="list" id="restaurantList"></div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="restaurantName" placeholder="Enter restaurant name">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="restaurantAddress" placeholder="Enter address">
                </div>
                <button onclick="addRestaurant()">Add Restaurant</button>
            </div>

            <!-- Pizzas Section -->
            <div class="card">
                <h2>Pizzas</h2>
                <div class="message" id="pizzaMessage"></div>
                <div class="list" id="pizzaList"></div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="pizzaName" placeholder="Enter pizza name">
                </div>
                <div class="form-group">
                    <label>Ingredients</label>
                    <input type="text" id="pizzaIngredients" placeholder="Enter ingredients">
                </div>
                <button onclick="addPizza()">Add Pizza</button>
            </div>

            <!-- Restaurant Pizzas Section -->
            <div class="card">
                <h2>Restaurant Pizzas</h2>
                <div class="message" id="rpizzaMessage"></div>
                <div class="list" id="rpizzaList"></div>
                <div class="form-group">
                    <label>Restaurant</label>
                    <select id="rpizzaRestaurant"></select>
                </div>
                <div class="form-group">
                    <label>Pizza</label>
                    <select id="rpizzaPizza"></select>
                </div>
                <div class="form-group">
                    <label>Price</label>
                    <input type="number" id="rpizzaPrice" step="0.01" placeholder="Enter price (0-30)">
                </div>
                <button onclick="addRestaurantPizza()">Link Pizza to Restaurant</button>
            </div>
        </div>
    </div>

    <script>
        // Utility function to show messages
        function showMessage(elementId, message, isError = false) {
            const elem = document.getElementById(elementId);
            elem.textContent = message;
            elem.className = 'message ' + (isError ? 'error' : 'success');
            setTimeout(() => { elem.className = 'message'; }, 5000);
        }

        // Load Restaurants
        async function loadRestaurants() {
            try {
                const res = await fetch('/restaurants');
                const data = await res.json();
                const list = document.getElementById('restaurantList');
                list.innerHTML = data.length ? data.map(r => 
                    `<div class="list-item">
                        <div><strong>${r.name}</strong><br><small>${r.address}</small></div>
                        <button onclick="viewRestaurant(${r.id})">View</button>
                        <button onclick="deleteRestaurant(${r.id})">Delete</button>
                    </div>`
                ).join('') : '<div class="empty-state">No restaurants yet</div>';
            } catch (err) {
                console.error(err);
            }
        }

        // Add Restaurant
        async function addRestaurant() {
            const name = document.getElementById('restaurantName').value;
            const address = document.getElementById('restaurantAddress').value;
            if (!name || !address) {
                showMessage('restaurantMessage', 'Name and address required', true);
                return;
            }
            try {
                const res = await fetch('/restaurants', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, address })
                });
                if (!res.ok) throw new Error('Failed to add');
                showMessage('restaurantMessage', 'Restaurant added!');
                document.getElementById('restaurantName').value = '';
                document.getElementById('restaurantAddress').value = '';
                loadRestaurants();
                loadRestaurantDropdown();
            } catch (err) {
                showMessage('restaurantMessage', err.message, true);
            }
        }

        // View Restaurant with Pizzas
        async function viewRestaurant(id) {
            try {
                const res = await fetch(`/restaurants/${id}`);
                if (!res.ok) throw new Error('Not found');
                const r = await res.json();
                const pizzas = r.restaurant_pizzas?.map(rp => `${rp.pizza.name} - $${rp.price}`).join(', ') || 'None';
                showMessage('restaurantMessage', `${r.name} (${r.address})\nPizzas: ${pizzas}`);
            } catch (err) {
                showMessage('restaurantMessage', 'Restaurant not found', true);
            }
        }

        // Delete Restaurant
        async function deleteRestaurant(id) {
            if (!confirm('Delete this restaurant?')) return;
            try {
                const res = await fetch(`/restaurants/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete');
                showMessage('restaurantMessage', 'Restaurant deleted!');
                loadRestaurants();
                loadRestaurantDropdown();
            } catch (err) {
                showMessage('restaurantMessage', err.message, true);
            }
        }

        // Load Pizzas
        async function loadPizzas() {
            try {
                const res = await fetch('/pizzas');
                const data = await res.json();
                const list = document.getElementById('pizzaList');
                list.innerHTML = data.length ? data.map(p => 
                    `<div class="list-item">
                        <div><strong>${p.name}</strong><br><small>${p.ingredients}</small></div>
                    </div>`
                ).join('') : '<div class="empty-state">No pizzas yet</div>';
            } catch (err) {
                console.error(err);
            }
        }

        // Add Pizza
        async function addPizza() {
            const name = document.getElementById('pizzaName').value;
            const ingredients = document.getElementById('pizzaIngredients').value;
            if (!name || !ingredients) {
                showMessage('pizzaMessage', 'Name and ingredients required', true);
                return;
            }
            try {
                const res = await fetch('/pizzas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, ingredients })
                });
                if (!res.ok) throw new Error('Failed to add');
                showMessage('pizzaMessage', 'Pizza added!');
                document.getElementById('pizzaName').value = '';
                document.getElementById('pizzaIngredients').value = '';
                loadPizzas();
                loadPizzaDropdown();
            } catch (err) {
                showMessage('pizzaMessage', err.message, true);
            }
        }

        // Load Restaurant Dropdown
        async function loadRestaurantDropdown() {
            try {
                const res = await fetch('/restaurants');
                const data = await res.json();
                const select = document.getElementById('rpizzaRestaurant');
                select.innerHTML = '<option value="">Select a restaurant</option>' + 
                    data.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            } catch (err) {
                console.error(err);
            }
        }

        // Load Pizza Dropdown
        async function loadPizzaDropdown() {
            try {
                const res = await fetch('/pizzas');
                const data = await res.json();
                const select = document.getElementById('rpizzaPizza');
                select.innerHTML = '<option value="">Select a pizza</option>' + 
                    data.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            } catch (err) {
                console.error(err);
            }
        }

        // Load Restaurant Pizzas
        async function loadRestaurantPizzas() {
            try {
                const res = await fetch('/restaurants');
                const restaurants = await res.json();
                const list = document.getElementById('rpizzaList');
                let html = '';
                for (const r of restaurants) {
                    if (r.restaurant_pizzas?.length) {
                        for (const rp of r.restaurant_pizzas) {
                            html += `<div class="list-item">
                                <div><strong>${r.name}</strong> - ${rp.pizza.name}<br><small>$${rp.price}</small></div>
                            </div>`;
                        }
                    }
                }
                list.innerHTML = html || '<div class="empty-state">No restaurant-pizza links yet</div>';
            } catch (err) {
                console.error(err);
            }
        }

        // Add Restaurant Pizza
        async function addRestaurantPizza() {
            const restaurant_id = document.getElementById('rpizzaRestaurant').value;
            const pizza_id = document.getElementById('rpizzaPizza').value;
            const price = document.getElementById('rpizzaPrice').value;
            if (!restaurant_id || !pizza_id || !price) {
                showMessage('rpizzaMessage', 'All fields required', true);
                return;
            }
            try {
                const res = await fetch('/restaurant_pizzas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        restaurant_id: parseInt(restaurant_id), 
                        pizza_id: parseInt(pizza_id), 
                        price: parseFloat(price) 
                    })
                });
                const result = await res.json();
                if (!res.ok) {
                    const error = result.errors ? result.errors.join(', ') : 'Failed to add';
                    throw new Error(error);
                }
                showMessage('rpizzaMessage', 'Restaurant-Pizza link created!');
                document.getElementById('rpizzaRestaurant').value = '';
                document.getElementById('rpizzaPizza').value = '';
                document.getElementById('rpizzaPrice').value = '';
                loadRestaurantPizzas();
            } catch (err) {
                showMessage('rpizzaMessage', err.message, true);
            }
        }

        // Initialize on page load
        window.onload = () => {
            loadRestaurants();
            loadPizzas();
            loadRestaurantPizzas();
            loadRestaurantDropdown();
            loadPizzaDropdown();
            // Refresh every 5 seconds
            setInterval(() => {
                loadRestaurants();
                loadPizzas();
                loadRestaurantPizzas();
            }, 5000);
        };
    </script>
</body>
</html>
